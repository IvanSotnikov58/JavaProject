<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>Матч — Hearthclone</title>
    <style>
        body{font-family:system-ui;padding:20px;background:#f3f4f6}
        .panel{background:#fff;padding:12px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,.06);margin-bottom:12px}
        select,input,button{padding:8px;margin-top:6px}
        label{display:block;margin-top:8px}
        .log{max-height:240px;overflow:auto;background:#f9fafb;padding:8px;border-radius:6px}
    </style>
</head>
<body>
<header style="display:flex;align-items:center;gap:12px;padding:12px;background:#fff;margin-bottom:12px;border-bottom:1px solid #eee">
    <h1 style="margin:0;font-size:1.1rem">Hearthclone</h1>
    <nav style="margin-left:8px">
        <a href="/index.html">Главная</a> |
        <a href="/deckbuilder.html">Сборщик</a> |
        <a href="/match.html">Матч</a> |
        <a href="/login.html" id="nav-login-link">Логин</a>
    </nav>

    <div style="margin-left:auto;text-align:right">
        <div id="nav-user" class="small" style="font-size:0.9rem;color:#333"></div>
        <button id="nav-logout" style="display:none;margin-top:4px;padding:4px 8px">Выйти</button>
    </div>
</header>

<script>
    // Показывать имя пользователя и кнопку logout во всех страницах
    (function(){
      const name = localStorage.getItem('hc_userName');
      const id = localStorage.getItem('hc_userId');
      const navUser = document.getElementById('nav-user');
      const navLogout = document.getElementById('nav-logout');
      const navLoginLink = document.getElementById('nav-login-link');

      if(name && id){
        navUser.textContent = 'Вы: ' + name + ' (id:' + id + ')';
        navLogout.style.display = 'inline-block';
        navLoginLink.style.display = 'none';
      } else {
        navUser.textContent = 'Не вошёл';
        navLogout.style.display = 'none';
        navLoginLink.style.display = 'inline';
      }

      navLogout?.addEventListener('click', () => {
        localStorage.removeItem('hc_userId');
        localStorage.removeItem('hc_userName');
        // обновим страницу чтобы меню обновилось
        location.reload();
      });
    })();
</script>

<h1>Матч</h1>
<div class="panel">
    <h3>Создать матч</h3>
    <label>Игрок 1</label>
    <select id="p1"></select>
    <label>Игрок 2</label>
    <select id="p2"></select>
    <div style="margin-top:8px">
        <button id="createMatch">Создать матч</button>
        <span id="created" class="small"></span>
    </div>
</div>

<div class="panel">
    <h3>Играть</h3>
    <label>Match ID</label>
    <input id="matchIdInput" />
    <button id="loadMatch">Загрузить матч</button>

    <div id="matchArea" style="display:none;margin-top:12px">
        <div><b>Match id: </b><span id="mid"></span> <b>status:</b> <span id="mstatus"></span></div>
        <label>Кто ходит (playerId)</label>
        <input id="playerId" />
        <label>Card ID</label>
        <input id="cardId" />
        <label>Target (строка)</label>
        <input id="target" />
        <label>Результат (отладка)</label>
        <input id="result" />
        <label>Turn number</label>
        <input id="turnNumber" type="number" value="1" />
        <div style="margin-top:8px">
            <button id="playBtn">Сыграть карту</button>
        </div>
        <h4>Лог ходов</h4>
        <div id="log" class="log"></div>
    </div>
</div>

<script>
    async function loadPlayers(){
      const r = await fetch('/users');
      const users = await r.json();
      const p1 = document.getElementById('p1');
      const p2 = document.getElementById('p2');
      p1.innerHTML = users.map(u => `<option value="${u.id}">${u.name} (id:${u.id})</option>`).join('');
      p2.innerHTML = p1.innerHTML;
    }

    document.getElementById('createMatch').addEventListener('click', async () => {
      const p1 = document.getElementById('p1').value;
      const p2 = document.getElementById('p2').value;
      try {
        const r = await fetch(`/matches?player01Id=${p1}&player02Id=${p2}`, { method: 'POST' });
        if(!r.ok) throw new Error(r.status);
        const match = await r.json();
        document.getElementById('created').textContent = 'Match created id:' + match.id;
        document.getElementById('matchIdInput').value = match.id;
      } catch(e){
        alert('Ошибка создания матча: ' + e);
      }
    });

    document.getElementById('loadMatch').addEventListener('click', async () => {
      const id = document.getElementById('matchIdInput').value;
      if(!id) return alert('Введите match id');
      try {
        const r = await fetch(`/matches/${id}`);
        if(!r.ok) throw new Error(r.status);
        const match = await r.json(); // note: backend returns Optional — might be wrapper; handles both
        const real = match && match.id ? match : match[0] || match; // robust-ish
        document.getElementById('mid').textContent = real.id;
        document.getElementById('mstatus').textContent = real.status;
        document.getElementById('matchArea').style.display = 'block';
        // prefill playerId to local storage user if present
        const stored = localStorage.getItem('hc_userId');
        if(stored) document.getElementById('playerId').value = stored;
        appendLog('Матч загружен: ' + JSON.stringify(real));
      } catch(e){
        alert('Ошибка загрузки матча: ' + e);
      }
    });

    document.getElementById('playBtn').addEventListener('click', async () => {
      const matchId = document.getElementById('mid').textContent || document.getElementById('matchIdInput').value;
      const playerId = document.getElementById('playerId').value;
      const cardId = document.getElementById('cardId').value;
      const target = document.getElementById('target').value || '';
      const result = document.getElementById('result').value || '';
      const turnNumber = document.getElementById('turnNumber').value || 1;

      if(!matchId || !playerId || !cardId) return alert('matchId, playerId и cardId обязательны');

      try {
        const url = `/matches/${matchId}/play?playerId=${playerId}&cardId=${cardId}&target=${encodeURIComponent(target)}&result=${encodeURIComponent(result)}&turnNumber=${turnNumber}`;
        const r = await fetch(url, { method:'POST' });
        if(!r.ok) throw new Error('HTTP ' + r.status);
        appendLog(`Ход отправлен: player=${playerId} card=${cardId} turn=${turnNumber}`);
        // увеличиваем номер хода для удобства
        document.getElementById('turnNumber').value = Number(turnNumber) + 1;
        // обновим статус матча
        const mr = await fetch(`/matches/${matchId}`);
        const match = await mr.json();
        document.getElementById('mstatus').textContent = match.status || (match[0] && match[0].status) || 'UNKNOWN';
      } catch(e){
        appendLog('Ошибка при отправке хода: ' + e);
      }
    });

    function appendLog(s){
      const log = document.getElementById('log');
      const line = document.createElement('div');
      line.textContent = (new Date()).toLocaleTimeString() + ' — ' + s;
      log.prepend(line);
    }

    loadPlayers();
</script>
</body>
</html>
