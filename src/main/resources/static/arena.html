<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>Arena Hearthclone (New)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        :root{
          --bg:#0b0d10;
          --panel:#13161a;
          --muted:#9aa0ac;
          --accent:#ffcc33;
          --accent-2:#ffdb55;
          --card:#1b1f25;
          --card-2:#192025;
          --shadow: 0 10px 30px rgba(0,0,0,0.6);
        }
        html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#e9eef2}
        .wrap{max-width:1200px;margin:18px auto;padding:18px}
        header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:12px}
        h1{margin:0;font-size:22px}
        nav a{color:var(--muted);text-decoration:none;margin-left:10px}
        .top-info{color:var(--muted);font-size:13px}

        .board{display:flex;gap:18px}
        .col{background:var(--panel);padding:14px;border-radius:10px;box-shadow:var(--shadow);flex:1;min-height:420px}
        .col.small{flex:0 0 320px;max-width:320px}
        .section-title{font-size:14px;color:var(--muted);margin-bottom:8px}

        .deck-summary{background:linear-gradient(180deg,var(--card),var(--card-2));padding:10px;border-radius:8px}
        .deck-count{font-weight:700;font-size:18px;color:var(--accent)}

        .area{min-height:120px;border-radius:8px;padding:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
        .hand{display:flex;gap:8px;flex-wrap:wrap}
        .card{
          width:140px;
          background:linear-gradient(180deg,#111217,#131821);
          border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.03);
          box-shadow:0 6px 16px rgba(0,0,0,0.5);cursor:pointer;
          display:flex;flex-direction:column;justify-content:space-between;
        }
        .card .name{font-weight:700;margin-bottom:6px}
        .card .meta{font-size:13px;color:var(--muted)}
        .card.playable{outline:2px solid rgba(255,204,51,0.18)}
        .card.small{width:100%;display:flex;justify-content:space-between;padding:6px;font-size:14px}

        .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
        button{background:linear-gradient(180deg,var(--accent),var(--accent-2));border:none;padding:10px 12px;border-radius:8px;font-weight:700;cursor:pointer;color:#111}
        .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
        .log{max-height:420px;overflow:auto;background:#071017;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);font-size:13px;color:var(--muted)}

        .small-note{font-size:13px;color:var(--muted);margin-top:8px}
        .center{display:flex;justify-content:center;align-items:center;flex-direction:column;gap:12px}

        @media (max-width:960px){
          .board{flex-direction:column}
          .col.small{max-width:none;flex:unset}
          .card{width:120px}
        }
    </style>
</head>
<body>
<div class="wrap">
    <header>
        <div>
            <h1>Арена Hearthclone</h1>
            <div class="top-info">Игрок: <span id="playerName">—</span> · <span id="playerStats">рейтинг - · wins - / losses -</span></div>
        </div>
        <div>
            <a class="btn-ghost" href="/index.html">Меню</a>
            <a class="btn-ghost" href="/deckbuilder.html" style="margin-left:8px">Сборщик</a>
        </div>
    </header>

    <div class="board">
        <div class="col small">
            <div class="section-title">Колода</div>
            <div class="deck-summary">
                <div>Карты в колоде: <span id="deckCount" class="deck-count">0</span></div>
                <div class="small-note" id="deckSizeNote">Ожидается до 10 карт</div>
                <div style="margin-top:10px">
                    <button id="btnShuffle">Shuffle</button>
                    <button id="btnReset" class="btn-ghost" style="margin-left:8px">Reset</button>
                </div>
            </div>

            <div style="margin-top:12px">
                <div class="section-title">Состав колоды</div>
                <div id="deckList" class="area" style="min-height:220px;overflow:auto"></div>
            </div>
        </div>


        <div class="col">
            <div class="section-title">Арена</div>

            <div class="center">
                <div style="width:100%;display:flex;justify-content:space-between;align-items:center">
                    <div>Deck → Hand → Battlefield</div>
                    <div>
                        <button id="btnStart">Start</button>
                    </div>
                </div>

                <div style="width:100%;margin-top:12px">
                    <div class="section-title">Рука</div>
                    <div id="handArea" class="area hand" style="min-height:140px"></div>
                </div>

                <div style="width:100%;margin-top:12px">
                    <div class="section-title">Поле (твои сыгранные карты)</div>
                    <div id="battleArea" class="area" style="min-height:140px;display:flex;gap:8px;flex-wrap:wrap"></div>
                </div>

                <div style="width:100%;margin-top:12px;display:flex;justify-content:space-between">
                    <div class="small-note">Ходов сделано: <span id="turnCount">0</span></div>
                    <div class="small-note">Карты в колоде: <span id="deckLeft">0</span></div>
                    <div class="small-note">Мана: <span id="currentMana">0</span> / <span id="maxMana">0</span></div>
                </div>
            </div>
        </div>


        <div class="col small">
            <div class="section-title">Лог</div>
            <div id="log" class="log"></div>
        </div>
    </div>
</div>

<script>
    async function fetchJsonSafe(url){
      try {
        const r = await fetch(url);
        if(!r.ok) return { ok:false, status:r.status, body: await r.text().catch(()=>null) };
        const body = await r.json().catch(()=>null);
        return { ok:true, body };
      } catch(e){ return { ok:false, error:e }; }
    }


    let user = { id:null, name:null };
    let matchId = null;
    let hand = [];
    let field = [];
    let deckLeft = 0;
    let turnCount = 0;
    let currentMana = 0;
    let maxMana = 0;


    let chosenDeck = null;
    let localDeck = [];
    const START_HAND = 3;
    const MAX_HAND = 6;


    const deckListEl = document.getElementById('deckList');
    const deckCountEl = document.getElementById('deckCount');
    const deckLeftEl = document.getElementById('deckLeft');
    const handArea = document.getElementById('handArea');
    const battleArea = document.getElementById('battleArea');
    const turnCountEl = document.getElementById('turnCount');
    const currentManaEl = document.getElementById('currentMana');
    const maxManaEl = document.getElementById('maxMana');
    const logEl = document.getElementById('log');

    function log(msg){ const div=document.createElement('div'); div.textContent = new Date().toLocaleTimeString() + ' - ' + msg; logEl.prepend(div); }


    function shuffleInPlace(arr){
      for(let i = arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }


    async function initPage(){
      user.id = localStorage.getItem('hc_userId');
      user.name = localStorage.getItem('hc_userName');
      document.getElementById('playerName').textContent = user.name||'-';
      document.getElementById('playerStats').textContent = user.id ? 'id '+user.id:'не в системе';

      if(!user.id){
        log('Нет игрока'); return;
      }


      const res = await fetchJsonSafe(`/decks/player/${user.id}`);
      if(!res.ok){ log('Ошибка загрузки колоды'); return; }

      if(Array.isArray(res.body) && res.body.length>0){
          chosenDeck = res.body[res.body.length-1];
      } else if(res.body && res.body.id){
          chosenDeck = res.body;
      } else if(res.body && res.body.decks && Array.isArray(res.body.decks) && res.body.decks.length>0){
          chosenDeck = res.body.decks[res.body.decks.length-1];
      } else {
          log('Колода пуста');
          return;
      }

      const cardsArr = chosenDeck.cards || chosenDeck.cardList || chosenDeck.cardsList || [];
      renderDeckList(cardsArr);


      deckLeft = cardsArr.length;
      deckLeftEl.textContent = deckLeft;

      //пробуем создать матч, елси нет то локально
      const matchRes = await fetchJsonSafe(`/matches/create?player01=${user.id}&player02=${user.id}`);
      if(matchRes.ok && matchRes.body && matchRes.body.id){
        matchId = matchRes.body.id;
        log('матч создан: ' + matchId);
        await refreshMatchState();
      } else {
        log('матч не создан');
      }
    }

    function renderDeckList(cards){
      deckListEl.innerHTML = '';
      cards.forEach(c=>{
        const d=document.createElement('div');
        d.className='card small';
        d.innerHTML=`<span>${c.name}</span><span class="meta">cost ${c.cost}</span>`;
        deckListEl.appendChild(d);
      });
      deckCountEl.textContent = cards.length;
    }


    async function refreshMatchState(){
      if(!matchId) return;
      const res = await fetchJsonSafe(`/matches/${matchId}`);
      if(!res.ok || !res.body) return;
      const match = res.body;

      turnCount = match.turnCounter ?? match.turnNumber ?? turnCount;

      const handRes = await fetchJsonSafe(`/matches/${matchId}/hand/${user.id}`);
      hand = handRes.ok && Array.isArray(handRes.body) ? handRes.body : [];
      const fieldRes = await fetchJsonSafe(`/matches/${matchId}/field/${user.id}`);
      field = fieldRes.ok && Array.isArray(fieldRes.body) ? fieldRes.body : [];
      deckLeft = match.player01DeckCount ?? deckLeft;
      currentMana = match.currentMana ?? currentMana;
      maxMana = match.maxMana ?? maxMana;
      updateUI();
    }


    function updateUI(){
      turnCountEl.textContent = turnCount;
      deckLeftEl.textContent = deckLeft;
      currentManaEl.textContent = currentMana;
      maxManaEl.textContent = maxMana;


      handArea.innerHTML = hand.length ? '' : '<div class="small-note">Рука пуста</div>';
      hand.forEach((c,idx)=>{
        const el = document.createElement('div');
        el.className='card';
        el.dataset.index=idx;
        el.innerHTML=`<div><div class="name">${c.name}</div><div class="meta">cost ${c.cost} · id:${c.id}</div></div><div class="meta" style="text-align:right;font-size:12px">клик чтобы сыграть</div>`;
        el.addEventListener('click',()=>playCard(idx));
        handArea.appendChild(el);
      });


      battleArea.innerHTML = field.length ? '' : '<div class="small-note">Поле пусто</div>';
      field.forEach(c=>{
        const el = document.createElement('div');
        el.className='card';
        el.style.width='120px';
        el.innerHTML=`<div class="name">${c.name}</div><div class="meta">HP:${c.health ?? '-'} DMG:${c.damage ?? '-'} ${c.taunt?'TAUNT':''}</div>`;
        battleArea.appendChild(el);
      });
    }


    function localResetState(){
      const cardsArr = chosenDeck ? (chosenDeck.cards || chosenDeck.cardList || chosenDeck.cardsList || []) : [];
      localDeck = cardsArr.map(c => ({...c}));
      shuffleInPlace(localDeck);
      hand = [];
      field = [];
      turnCount = 0;
      currentMana = 1; //начальная мана
      maxMana = 1;
      deckLeft = localDeck.length;
      updateUI();
      log('Локальное состояние сброшено');
    }

    function localDrawCard(incTurn = true){
      if(localDeck.length === 0){
        log('Нельзя взять: локальная колода пуста');
        return;
      }
      if(hand.length >= MAX_HAND){
        log('Нельзя взять: рука полна ('+MAX_HAND+')');
        return;
      }
      const card = localDeck.shift();
      hand.push(card);
      deckLeft = localDeck.length;
      if(incTurn) turnCount++;
      updateUI();
      log('Взята карта (локально): ' + (card.name || card.id));
    }

    async function startLocalMatch(){
      if(!chosenDeck){
        log('Нет загруженной колоды для старта');
        return;
      }
      localResetState();
      for(let i=0;i<START_HAND;i++) localDrawCard(false);
      turnCount = 0;
      updateUI();
      log('Локальный матч стартовал, рука из ' + START_HAND + ' карт');
    }


    async function playCard(index){
      if(index<0 || index>=hand.length) return;


      if(matchId){
        const card = hand[index];
        const res = await fetchJsonSafe(`/matches/${matchId}/play?playerId=${user.id}&cardId=${card.id}&action=PLAY`);
        if(res.ok){
          log('Сыграна карта (сервер): ' + card.name);
          await refreshMatchState();
        } else {
          log('Не удалось сыграть карту: ' + (res.status || res.error));
        }
        return;
      }


      const card = hand[index];
      const cost = card.cost ?? 0;
      if(currentMana < cost){
        log('Недостаточно маны для этой карты (стоимость ' + cost + ', есть ' + currentMana + ')');
        return;
      }

      currentMana -= cost;

      const cardInstance = {
        id: card.id,
        name: card.name,
        damage: card.damage ?? 0,
        health: card.health ?? 0,
        taunt: (card.effectKey === 'TAUNT')
      };

      hand.splice(index,1);
      field.push(cardInstance);

      turnCount++;
      if(localDeck.length > 0) localDrawCard(false);
      deckLeft = localDeck.length;
      updateUI();
      log('Сыграна карта (локально): ' + card.name + ' cost ' + cost);
    }


    document.getElementById('btnStart').addEventListener('click', async ()=>{
      log('Start pressed');
      if(matchId){
        await refreshMatchState();
        log('Состояние обновлено с сервера (matchId=' + matchId + ')');
        return;
      }
      await startLocalMatch();
    });

    document.getElementById('btnShuffle').addEventListener('click', ()=>{
      if(localDeck && localDeck.length>0){
        shuffleInPlace(localDeck);
        log(' колода перемешана');
        updateUI();
        return;
      }

      if(chosenDeck){
        localDeck = (chosenDeck.cards || chosenDeck.cardList || []).map(c=>({...c}));
        shuffleInPlace(localDeck);
        log('Колода перемешана);
        deckLeft = localDeck.length;
        updateUI();
        return;
      }
      log('Нет колоды для перемешивания');
    });

    document.getElementById('btnReset').addEventListener('click', ()=>{
      if(matchId){
        log('Reset ignored for server match (refreshing instead)');
        refreshMatchState();
        return;
      }
      localResetState();
      log('Reset выполнен (локально)');
    });

    // start
    initPage();
</script>
</body>
</html>
