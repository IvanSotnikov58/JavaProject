<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Login — Hearthclone</title>
  <style>
    body{font-family:system-ui;padding:20px;background:#fafafa}
    .card{background:#fff;padding:12px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,.06);max-width:520px}
    label{display:block;margin-top:8px}
    select,input{width:100%;padding:8px;margin-top:6px}
    button{margin-top:10px;padding:8px 12px}
    .small{font-size:0.9rem;color:#666}
    #msg{margin-top:8px}
  </style>
</head>
<body>

<header style="display:flex;align-items:center;gap:12px;padding:12px;background:#fff;margin-bottom:12px;border-bottom:1px solid #eee">
  <h1 style="margin:0;font-size:1.1rem">Hearthclone</h1>
  <nav style="margin-left:8px">
    <a href="/index.html">Главная</a> |
    <a href="/deckbuilder.html">Сборщик</a> |
    <a href="/match.html">Матч</a> |
    <a href="/login.html" id="nav-login-link">Логин</a>
  </nav>

  <div style="margin-left:auto;text-align:right">
    <div id="nav-user" class="small" style="font-size:0.9rem;color:#333"></div>
    <button id="nav-logout" style="display:none;margin-top:4px;padding:4px 8px">Выйти</button>
  </div>
</header>

<script>
  // Показывать имя пользователя и кнопку logout во всех страницах
  (function(){
    const name = localStorage.getItem('hc_userName');
    const id = localStorage.getItem('hc_userId');
    const navUser = document.getElementById('nav-user');
    const navLogout = document.getElementById('nav-logout');
    const navLoginLink = document.getElementById('nav-login-link');

    if(name && id){
      navUser.textContent = 'Вы: ' + name + ' (id:' + id + ')';
      navLogout.style.display = 'inline-block';
      navLoginLink.style.display = 'none';
    } else {
      navUser.textContent = 'Не вошёл';
      navLogout.style.display = 'none';
      navLoginLink.style.display = 'inline';
    }

    navLogout?.addEventListener('click', () => {
      localStorage.removeItem('hc_userId');
      localStorage.removeItem('hc_userName');
      location.reload();
    });
  })();

  function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
</script>

<div class="card" style="margin-top:12px">
  <h2>Войти / выбрать пользователя</h2>
  <p class="small">Введи пароль — будет попытка вызвать <code>/auth/login</code>. Если сервер авторизации недоступен, используй кнопку «Быстрый выбор».</p>

  <label for="userSelect">Пользователь:</label>
  <select id="userSelect"></select>

  <label for="password">Пароль:</label>
  <input id="password" type="password" placeholder="Введите пароль (если есть)" />

  <div style="display:flex;gap:8px;margin-top:10px">
    <button id="btnLogin">Войти</button>
    <button id="btnQuick">Быстрый выбор (без пароля)</button>
  </div>

  <p id="msg" class="small"></p>
</div>

<script>
  async function loadUsers() {
    const sel = document.getElementById('userSelect');
    sel.innerHTML = '<option>Загрузка...</option>';
    try {
      const r = await fetch('/users');
      if(!r.ok) throw new Error('HTTP ' + r.status);
      const users = await r.json();
      sel.innerHTML = users.map(u => `<option value="${u.id}">${escapeHtml(u.name)} (id:${u.id})</option>`).join('');
    } catch(e){
      sel.innerHTML = '<option>Ошибка загрузки</option>';
      document.getElementById('msg').textContent = 'Не удалось загрузить пользователей: ' + e;
    }
  }

  document.getElementById('btnLogin').addEventListener('click', async () => {
    const sel = document.getElementById('userSelect');
    const id = sel.value;
    const password = document.getElementById('password').value || '';
    const msg = document.getElementById('msg');
    msg.textContent = '';
    msg.style.color = '';

    if(!id){ msg.textContent = 'Выберите пользователя'; return; }

    // Формируем payload соответствующий AuthService (name + password)
    const name = sel.options[sel.selectedIndex].text.split(' (')[0];

    try {
      const r = await fetch('/auth/login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ name: name, password: password })
      });

      if (r.status === 401) {
        msg.style.color = 'red';
        msg.textContent = 'Неверный пароль.';
        return;
      }

      if (!r.ok) {
        // Сервер вернул ошибку отличную от 401 (например 404 если эндпоинта нет)
        msg.style.color = 'orange';
        msg.textContent = 'Сервер авторизации временно недоступен. Можешь использовать "Быстрый выбор".';
        return;
      }

      // Успех
      const user = await r.json();
      localStorage.setItem('hc_userId', user.id ?? id);
      localStorage.setItem('hc_userName', user.name ?? name);
      msg.style.color = 'green';
      msg.textContent = 'Успешный вход: ' + (user.name ?? name);
      setTimeout(()=>location.href = '/index.html', 400);

    } catch (err) {
      // Сетевая ошибка
      msg.style.color = 'orange';
      msg.textContent = 'Невозможно связаться с сервером авторизации. Используйте кнопку "Быстрый выбор" для тестирования.';
      console.error(err);
    }
  });

  // Быстрый выбор — только по кнопке, без автоматического срабатывания
  document.getElementById('btnQuick').addEventListener('click', () => {
    const sel = document.getElementById('userSelect');
    const id = sel.value;
    if(!id) {
      document.getElementById('msg').textContent = 'Выберите пользователя';
      return;
    }
    const name = sel.options[sel.selectedIndex]?.text?.split(' (')[0] || id;
    localStorage.setItem('hc_userId', id);
    localStorage.setItem('hc_userName', name);
    document.getElementById('msg').style.color = 'green';
    document.getElementById('msg').textContent = 'Быстрый выбор: ' + name;
    setTimeout(()=>location.href = '/index.html', 400);
  });

  loadUsers();
</script>
</body>
</html>
